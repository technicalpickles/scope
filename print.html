<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Scope</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Home</a></li><li class="chapter-item expanded "><a href="doctor/index.html"><strong aria-hidden="true">2.</strong> Doctor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="doctor/doctor-setup.html"><strong aria-hidden="true">2.1.</strong> Doctor Setup</a></li><li class="chapter-item expanded "><a href="doctor/doctor-check.html"><strong aria-hidden="true">2.2.</strong> Doctor Check</a></li></ol></li><li class="chapter-item expanded "><a href="errors/known-error.html"><strong aria-hidden="true">3.</strong> Error Detection</a></li><li class="chapter-item expanded "><a href="report/upload.html"><strong aria-hidden="true">4.</strong> Report</a></li><li class="chapter-item expanded "><a href="report/intercept.html"><strong aria-hidden="true">5.</strong> Intercept</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Scope</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="scope"><a class="header" href="#scope">Scope</a></h1>
<p>Scope allows teams to define development config for engineers. Scope is a tool for engineers, to make them more productive.</p>
<p>The config falls into three major categories:</p>
<ul>
<li><a href="./doctor/index.html">Local setup</a></li>
<li><a href="./errors/known-error.html">Error debugging locally</a></li>
<li><a href="./report/upload.html">Generate great bug reports</a></li>
</ul>
<h2 id="config"><a class="header" href="#config">Config</a></h2>
<p>Configuration for <code>scope</code> is done via Kubernetes-like yaml files that live inside the repo. By default, scope will search up for the config directory <code>.scope</code> and ready <code>*.yaml</code> and <code>*.yml</code> files.</p>
<p>That means <code>.scope/foo.yaml</code> will be parsed as a config file, but <code>scope/foo.yaml</code> will not (notice the missing <code>.</code> before <code>scope</code>).</p>
<p>A config file looks like</p>
<pre><code class="language-yaml">apiVersion: scope.github.com/v1alpha
kind: &lt;kind&gt;
metadata:
  name: a useful name
spec:
  ...
</code></pre>
<p>Currently, the only supported <code>apiVersion</code> is <code>scope.github.com/v1alpha</code>. Using <code>apiVersion</code> allows scope to evolve the config file and keep older versions of the config compatible.</p>
<p>Unlike Kubernetes, the <code>name</code> field can be any string, without any DNS related constraints.</p>
<h2 id="commands"><a class="header" href="#commands">Commands</a></h2>
<p><code>scope</code> has 2 built-in commands that most engineers will use:</p>
<ul>
<li><code>doctor</code> - Run checks that will &quot;checkup&quot; your machine</li>
<li><code>report</code> - Generate a bug report based from a command</li>
</ul>
<p>Beyond the built-in command, scope will also run any binary prefixed with <code>scope-</code>.</p>
<p>Additionally, there is <code>list</code> that will output all the found configuration.</p>
<p>Here is an example output of <code>scope list</code> run from the <code>examples/</code> directory.</p>
<pre><code class="language-text">17:47:57  INFO More detailed logs at /tmp/scope/scope-root-20240112-SxCM.log
17:47:57  INFO Doctor Checks
17:47:57  INFO         Name                                Description                                           Path
17:47:57  INFO ------------------------------------------------------------------------------------------------------------------------
17:47:57  INFO     path-exists                Check your shell for basic functionality             .scope/doctor-check-path-exists.yaml
17:47:57  INFO path-exists-fix-in-scope-dir           Check your shell for basic functionality            .scope/doctor-check-fix-in-scope.yaml
17:47:57  INFO Doctor Setup
17:47:57  INFO         Name                                Description                                           Path
17:47:57  INFO ------------------------------------------------------------------------------------------------------------------------
17:47:57  INFO        setup                          You need to run bin/setup                           .scope/doctor-setup.yaml
17:47:57  INFO
17:47:57  INFO Known Errors
17:47:57  INFO         Name                                Description                                           Path
17:47:57  INFO ------------------------------------------------------------------------------------------------------------------------
17:47:57  INFO     error-exists                Check if the word error is in the logs                    .scope/known-error.yaml
17:47:57  INFO
17:47:57  INFO Commands
17:47:57  INFO         Name                                Description
17:47:57  INFO --------------------------------------------------------------------------------
17:47:57  INFO         bar                 External sub-command, run `scope bar` for help
17:47:57  INFO        doctor                Run checks that will &quot;checkup&quot; your machine
17:47:57  INFO         foo                 External sub-command, run `scope foo` for help
17:47:57  INFO         list             List the found config files, and resources detected
17:47:57  INFO        report          Generate a bug report based from a command that was ran
</code></pre>
<p>Under the <code>Commands</code> section, notice two additional commands:</p>
<ul>
<li><code>bar</code> which is located in <code>.scope/bin/scope-bar</code></li>
<li><code>foo</code> which is a binary on the <code>PATH</code></li>
</ul>
<p>Scope automatically adds <code>.scope/bin</code> to the path when searching. Allowing teams to add commands to scope in large repos. For example, in a mono-repo with multiple services, you may want to add a <code>deploy</code> command. The <code>deploy</code> command would come from the working dir.</p>
<h2 id="cli-options"><a class="header" href="#cli-options">CLI Options</a></h2>
<p>All commands support the following options</p>
<pre><code class="language-text">Usage: scope [OPTIONS] &lt;COMMAND&gt;

Options:
  -d, --debug...                     A level of verbosity, and can be used multiple times
  -w, --warn                         Enable warn logging
  -e, --error                        Disable everything but error logging
      --extra-config &lt;EXTRA_CONFIG&gt;  Add a paths to search for configuration. By default, `scope` will search up for `.scope` directories and attempt to load `.yml` and `.yaml` files for config. If the config directory is somewhere else, specifying this option will _add_ the paths/files to the loaded config [env: SCOPE_CONFIG_DIR=]
      --disable-default-config       When set, default config files will not be loaded and only specified config will be loaded [env: SCOPE_DISABLE_DEFAULT_CONFIG=]
  -C, --working-dir &lt;WORKING_DIR&gt;    Override the working directory
      --run-id &lt;RUN_ID&gt;              When outputting logs, or other files, the run-id is the unique value that will define where these go. In the case that the run-id is re-used, the old values will be overwritten [env: SCOPE_RUN_ID=]
  -h, --help                         Print help (see more with '--help')
  -V, --version                      Print version
</code></pre>
<p>Normally, you will not need to set any of these files.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="scope-doctor"><a class="header" href="#scope-doctor">Scope Doctor</a></h1>
<p>Scope supports two types of management instructions. <code>Setup</code> instructions are based on file contents, and <code>Check</code> instructions are based on scripts.</p>
<p>These instructions are run under the <code>doctor</code> subcommand. Both <code>Check</code> and <code>Setup</code> are run when <code>doctor</code> is run.</p>
<p>Both <code>Check</code> and <code>Setup</code> support <code>.spec.order</code> option, defaulting to 100. This allows you to specify that a command doctor step should be run earlier or later in the doctor process.</p>
<p>The <code>doctor</code> command will also run all the parent doctor steps. So in a large repo, multiple different levels can run.</p>
<p>To override a <code>doctor</code> step, create a new step, with the same <code>kind</code> and the same name. If they do not share the same <code>kind</code>, they will not be overwritten.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="doctor-setup"><a class="header" href="#doctor-setup">Doctor Setup</a></h1>
<p>Setup instructions are used to install dependencies, run db migrations, and other changes based on files present in the repo. These instructions will most often be run after a <code>git pull</code> or other similar step.</p>
<p>Looking at <code>doctor-setup.yaml</code> in the examples repo</p>
<pre><code class="language-yaml">apiVersion: scope.github.com/v1alpha
kind: ScopeDoctorSetup
metadata:
  name: setup
spec:
  # order: 100 # default value
  cache:
    paths:
      - '**/requirements.txt'
  setup:
    exec:
      - ../bin/pip-install.sh
  description: You need to run bin/setup
</code></pre>
<p>The kind is <code>ScopeDoctorSetup</code>, letting scope know that this is a Setup instruction.</p>
<h2 id="schema"><a class="header" href="#schema">Schema</a></h2>
<ul>
<li>
<p><code>.spec.cache.paths</code> is an array of <code>globstar</code> files that will be used to check for changes. These paths are relative to the &quot;project dir&quot;. If this file was at <code>$HOME/workspace/example/.scope/doctor-setup.yaml</code> the project dir would be <code>$HOME/workspace/example</code>. For this example, the search glob would be <code>$HOME/workspace/example/**/requirements.txt</code>.</p>
</li>
<li>
<p><code>.spec.setup.exec</code> is an array of commands to run when the cache is &quot;busted&quot;. The scripts are relative to the folder containing spec file. If this file was at <code>$HOME/workspace/example/.scope/doctor-setup.yaml</code> the command to run would be  <code>$HOME/workspace/example/.scope/../bin/pip-install.sh</code></p>
</li>
<li>
<p><code>.spec.description</code> is a useful description of the setup, used when listing what's available.</p>
</li>
<li>
<p><code>.spec.order</code> a number, defaulting to 100, that will change the order the step is run in. The lower the number, the earlier the step will be run.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="doctor-check"><a class="header" href="#doctor-check">Doctor Check</a></h1>
<p>Check instructions are used to verity the environment has dependencies working, usually things like a database or dependent services.</p>
<p>Looking at <code>doctor-check-path-exists.yaml</code> in the example folder.</p>
<pre><code class="language-yaml">apiVersion: scope.github.com/v1alpha
kind: ScopeDoctorCheck
metadata:
  name: path-exists
spec:
  check:
    target: scripts/does-path-env-exist.sh
  fix:
    target: ../bin/truey
  description: Check your shell for basic functionality
  help: You're shell does not have a path env. Reload your shell.
</code></pre>
<p>The kind is <code>ScopeDoctorCheck</code>, letting scope know that this is a Check instruction.</p>
<h2 id="schema-1"><a class="header" href="#schema-1">Schema</a></h2>
<ul>
<li>
<p><code>.spec.check.target</code> is a script to run, used to check if the system is working. If the script exits 0, that indicates success. Otherwise, that something is wrong. The scripts are relative to the folder containing spec file. If this file was at <code>$HOME/workspace/example/.scope/check.yaml</code> the command to run would be  <code>$HOME/workspace/example/.scope/scripts/does-path-env-exist.sh</code> </p>
</li>
<li>
<p><code>.spec.fix.target</code> is an optional command to run when the check fails. If provided, the fix will automatically run.</p>
</li>
<li>
<p><code>.spec.description</code> is a useful description of the setup, used when listing what's available.</p>
</li>
<li>
<p><code>.spec.help</code> text to provide to the user when the check fails, and if the fix fails.</p>
</li>
<li>
<p><code>.spec.order</code> a number, defaulting to 100, that will change the order the step is run in. The lower the number, the earlier the step will be run.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="known-errors"><a class="header" href="#known-errors">Known Errors</a></h1>
<p>A Known Error, provides a way for repo owners to describe errors that others may run into, and how to fix them.</p>
<p>A known error is only used when using the <code>intercept</code> binary.</p>
<p>Looking at <code>known-error.yaml</code> in the examples directory.</p>
<pre><code class="language-yaml">apiVersion: scope.github.com/v1alpha
kind: ScopeKnownError
metadata:
  name: error-exists
spec:
  description: Check if the word error is in the logs
  pattern: error
  help: The command had an error, try reading the logs around there to find out what happened.
</code></pre>
<ul>
<li><code>.spec.pattern</code> is a Regex that will be run over stdout and stderr to search for a known error.</li>
<li><code>.spec.help</code> is the description given when the pattern matches</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="report"><a class="header" href="#report">Report</a></h1>
<p>The <code>scope report</code> command is used to generate a bug report. The bug report is defined in a <code>ScopeReportDefinition</code>.</p>
<p>When reporting a bug, scope will auto redact well known keys and patterns to reduce sharing private information.</p>
<h2 id="scopereportdefinition"><a class="header" href="#scopereportdefinition"><code>ScopeReportDefinition</code></a></h2>
<p>There can only be one <code>ScopeReportDefinition</code> at any time. If there are multiple when searching, the &quot;closest&quot; is used.</p>
<p>Looking at <code>report.yaml</code> in the example directory.</p>
<pre><code class="language-yaml">apiVersion: scope.github.com/v1alpha
kind: ScopeReportDefinition
metadata:
  name: template
spec:
  additionalData:
    username: id -u
    ruby: which ruby
    node: which node
    nodeVersion: node -v
  template: |
    # There was an error!
    
    When running `{{ command }}` scope ran into an error
</code></pre>
<ul>
<li><code>.spec.additionalData</code> defines additional data that needs to be pulled from the system when reporting a bug. <code>additionalData</code> is a map of <code>string:string</code>, the value is a command that should be run. When a report is built, the commands will be run and automatically included in the report.</li>
<li><code>.spec.template</code> is a Jinja2 style template, to be included. The text should be in Markdown format. Scope injects <code>command</code> as the command that was run.</li>
</ul>
<h2 id="scopereportlocation"><a class="header" href="#scopereportlocation"><code>ScopeReportLocation</code></a></h2>
<p>Define where to upload the bug report to. Currently, only support <code>GitHubIssues</code> and <code>rustyPaste</code>.</p>
<h3 id="github-issues"><a class="header" href="#github-issues">GitHub Issues</a></h3>
<p>When reporting to GitHub Issues, the env-var <code>GH_TOKEN</code> must be set to get the API token.</p>
<p>Example in <code>report.yaml</code></p>
<pre><code class="language-yaml">---
apiVersion: scope.github.com/v1alpha
kind: ScopeReportLocation
metadata:
  name: github
spec:
  destination:
    githubIssue:
      owner: ethankhall
      repo: dummy-repo
</code></pre>
<h3 id="rustypaste"><a class="header" href="#rustypaste">RustyPaste</a></h3>
<p><a href="https://github.com/orhun/rustypaste">RustyPaste</a> is a pastebin style application. This may be a better choice when you can't require GitHub API token, or if there is a risk of sensitive data that shouldn't be in GitHub.</p>
<p>Example in <code>report.yaml</code></p>
<pre><code class="language-yaml">---
apiVersion: scope.github.com/v1alpha
kind: ScopeReportLocation
metadata:
  name: report
spec:
  destination:
    rustyPaste:
      url: http://localhost:8000
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="scope-intercept"><a class="header" href="#scope-intercept">Scope Intercept</a></h1>
<p>Reporting bugs after the fact is useful, but if the tool can determine that there was an error and prompt the user to report a bug is better. Scope Intercept is an <code>env</code> &quot;replacement&quot; that can be used in <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">shebang</a> in scripts.</p>
<p>Scope intercept captures stdout and stderr of any command that's run. In order to run the command, and to provide better compatibility <code>scope intercept</code> uses <code>env</code> under the hood to start the application.</p>
<p>When the script fails (exits with non 0), the user will be informed about KnownErrors, and then be prompted to report the error.</p>
<p><code>test.sh</code> in the examples repo, shows how the intercept may be used. The shebang is setup to use cargo to execute, in a production execution the script would look like</p>
<pre><code class="language-shell">#!/usr/bin/scope-intercept -- -ddd --extra-config examples bash

&gt;&amp;2 echo &quot;error 1!&quot;
sleep 1
echo &quot;hello world&quot;
exit 1
</code></pre>
<p>In the case that you expect non-0 exit codes, <code>--successful-exit</code> to add additional successful exit codes.</p>
<h2 id="help"><a class="header" href="#help">Help</a></h2>
<pre><code class="language-text">A wrapper CLI that can be used to capture output from a program, check if there are known errors and let the user know.

`scope-intercept` will execute `/usr/bin/env -S [utility] [args...]` capture the output from STDOUT and STDERR. After the program exits, the exit code will be checked, and if it's non-zero the output will be parsed for known errors.

Usage: scope-intercept [OPTIONS] &lt;UTILITY&gt; [ARGS]...

Arguments:
  &lt;UTILITY&gt;
          Command to execute withing scope-intercept

  [ARGS]...
          Arguments to be passed to the utility

Options:
(omit default params)

  -s, --successful-exit &lt;SUCCESSFUL_EXIT&gt;
          Add additional &quot;successful&quot; exit codes. A sub-command that exists 0 will always be considered a success
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
